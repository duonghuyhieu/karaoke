generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

model Song {
  id             String        @id @default(cuid())
  title          String
  artist         String
  youtubeId      String        @unique
  duration       String
  thumbnail      String?
  channelTitle   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  historyItems   HistoryItem[]
  queueItems     QueueItem[]
  currentInRooms Room[]        @relation("RoomCurrentSong")

  @@index([title])
  @@index([artist])
  @@index([createdAt])
  @@map("songs")
}

model Room {
  id            String        @id @default(cuid())
  roomId        String        @unique
  currentSongId String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  history       HistoryItem[]
  queue         QueueItem[]
  currentSong   Song?         @relation("RoomCurrentSong", fields: [currentSongId], references: [id])

  @@index([isActive])
  @@index([createdAt])
  @@map("rooms")
}

model QueueItem {
  id       String   @id @default(cuid())
  roomId   String
  songId   String
  position Int
  addedAt  DateTime @default(now())
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  song     Song     @relation(fields: [songId], references: [id])

  @@unique([roomId, position])
  @@index([roomId, position])
  @@index([addedAt])
  @@map("queue_items")
}

model HistoryItem {
  id       String   @id @default(cuid())
  roomId   String
  songId   String
  playedAt DateTime @default(now())
  duration Int?
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  song     Song     @relation(fields: [songId], references: [id])

  @@index([roomId, playedAt])
  @@index([playedAt])
  @@map("history_items")
}
